name: Update README timestamp

on:
  schedule:
    # 每天 00:00 UTC 触发一次
    - cron: '0 0 * * *'
  workflow_dispatch: {}

jobs:
  update-readme-timestamp:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Decide whether to run (every 59 days)
        id: decide
        run: |
          # 你可以根据需要修改这个偏移量，使“第一个执行日”对齐你想要的日期。
          OFFSET_DAYS=0

          # 当前是自 1970-01-01 起的整天数
          DAYS_SINCE_EPOCH=$(( $(date +%s) / 86400 ))

          # 计算距离偏移后的天数
          DELTA=$(( DAYS_SINCE_EPOCH - OFFSET_DAYS ))
          if [ "$DELTA" -lt 0 ]; then
            echo "Not reached offset day yet, skip."
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ $(( DELTA % 59 )) -ne 0 ]; then
            echo "Not a 59-day boundary, skip today."
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Today is a 59-day boundary, will update README."
          echo "run=true" >> "$GITHUB_OUTPUT"

      - name: Update README timestamp
        if: steps.decide.outputs.run == 'true'
        run: |
          set -e

          FILE="README.md"
          TS="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          LINE="Last workflow run: ${TS}"

          # 如果 README 不存在，直接创建
          if [ ! -f "$FILE" ]; then
            printf '%s\n\n' "# README" > "$FILE"
            printf '%s\n' "$LINE" >> "$FILE"
          else
            # 判断是否已有时间戳行（以 'Last workflow run:' 开头）
            if grep -qE '^Last workflow run:' "$FILE"; then
              # 替换已有时间戳行
              sed -i 's/^Last workflow run:.*/'"${LINE//\//\\/}"'/' "$FILE"
            else
              # 保证末尾有一个空行，再追加时间戳
              # 1. 如果文件最后一行不是空行，先加一个空行
              if [ -n "$(tail -n 1 "$FILE")" ]; then
                printf '\n' >> "$FILE"
              fi
              # 2. 追加时间戳行
              printf '%s\n' "$LINE" >> "$FILE"
            fi
          fi

          echo "Updated timestamp line to: $LINE"

      - name: Commit and push changes
        if: steps.decide.outputs.run == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add README.md
          git commit -m "chore: update README timestamp"
          git push
